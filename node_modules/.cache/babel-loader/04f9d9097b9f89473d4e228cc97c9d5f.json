{"ast":null,"code":"module.exports = authenticationBeforeRequest;\n\nconst btoa = require(\"btoa-lite\");\n\nconst withAuthorizationPrefix = require(\"./with-authorization-prefix\");\n\nfunction authenticationBeforeRequest(state, options) {\n  if (typeof state.auth === \"string\") {\n    options.headers.authorization = withAuthorizationPrefix(state.auth);\n    return;\n  }\n\n  if (state.auth.username) {\n    const hash = btoa(`${state.auth.username}:${state.auth.password}`);\n    options.headers.authorization = `Basic ${hash}`;\n\n    if (state.otp) {\n      options.headers[\"x-github-otp\"] = state.otp;\n    }\n\n    return;\n  }\n\n  if (state.auth.clientId) {\n    // There is a special case for OAuth applications, when `clientId` and `clientSecret` is passed as\n    // Basic Authorization instead of query parameters. The only routes where that applies share the same\n    // URL though: `/applications/:client_id/tokens/:access_token`.\n    //\n    //  1. [Check an authorization](https://developer.github.com/v3/oauth_authorizations/#check-an-authorization)\n    //  2. [Reset an authorization](https://developer.github.com/v3/oauth_authorizations/#reset-an-authorization)\n    //  3. [Revoke an authorization for an application](https://developer.github.com/v3/oauth_authorizations/#revoke-an-authorization-for-an-application)\n    //\n    // We identify by checking the URL. It must merge both \"/applications/:client_id/tokens/:access_token\"\n    // as well as \"/applications/123/tokens/token456\"\n    if (/\\/applications\\/:?[\\w_]+\\/tokens\\/:?[\\w_]+($|\\?)/.test(options.url)) {\n      const hash = btoa(`${state.auth.clientId}:${state.auth.clientSecret}`);\n      options.headers.authorization = `Basic ${hash}`;\n      return;\n    }\n\n    options.url += options.url.indexOf(\"?\") === -1 ? \"?\" : \"&\";\n    options.url += `client_id=${state.auth.clientId}&client_secret=${state.auth.clientSecret}`;\n    return;\n  }\n\n  return Promise.resolve().then(() => {\n    return state.auth();\n  }).then(authorization => {\n    options.headers.authorization = withAuthorizationPrefix(authorization);\n  });\n}","map":null,"metadata":{},"sourceType":"script"}